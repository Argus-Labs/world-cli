version: '3'

silent: true

vars:
  LINT_VERSION: v2.1.2

tasks:
  default:
    desc: Run linter for all code
    cmds:
      - task: _lint
        vars:
          FIX: false

  fix:
    desc: Run linter and automatically fix issues where possible
    cmds:
      - task: _lint
        vars:
          FIX: true

  _lint:
    internal: true
    deps: [_deps]
    cmds:
      - |
        echo "--> Running linter"
        {{if eq OS "windows"}}
          for /f "delims=" %%d in ('go list -f "{{$.Dir}}/..." -m') do (golangci-lint run --timeout=10m {{if .FIX}}--fix{{end}} --concurrency 8 -v %%d)
        {{else}}
          go list -f '{{.Dir}}/...' -m | xargs golangci-lint run --timeout=10m {{if .FIX}}--fix{{end}} --concurrency 8 -v
        {{end}}

  _deps:
    internal: true
    run: once
    desc: Install golangci-lint
    cmds:
      - |
        echo "--> Checking if golangci-lint {{.LINT_VERSION}} is installed"
        {{if eq OS "windows"}}
          where golangci-lint >NUL 2>&1 || (echo "--> Installing golangci-lint {{.LINT_VERSION}}" && go install github.com/golangci/golangci-lint@{{.LINT_VERSION}})
        {{else}}
          INSTALLED_VERSION=$(golangci-lint --version 2>/dev/null | awk '{print $4}' || echo "none")
          if [ "$INSTALLED_VERSION" != "{{.LINT_VERSION}}" ]; then
            echo "--> Installing golangci-lint {{.LINT_VERSION}}"
            go install github.com/golangci/golangci-lint@{{.LINT_VERSION}}
          else
            echo "--> golangci-lint {{.LINT_VERSION}} is already installed"
          fi
        {{end}}
